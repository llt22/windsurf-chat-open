# 更新日志

所有重要的项目变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.6.3] - 2026-01-20

### 修复
- **[关键修复]** 修复多轮对话后面板卡住的问题：当新请求到来时，Webview 仍显示旧对话，提交/结束操作无响应。
- **根本原因**：旧的 pending requests 没有被正确清理，导致新旧请求 ID 不匹配。
- **解决方案**：
  - `HttpService`: 新增 `clearAllPendingRequests()` 方法，当新请求到达时自动清理所有旧请求。
  - `Webview`: 新增 `isActive` 状态标志，防止对过时请求进行操作。
  - 增强日志记录，便于排查类似问题。

## [1.6.1] - 2026-01-15

### 修复
- **[兼容性修复]** 将脚本文件从 `.js` 改为 `.cjs` 扩展名，解决在设置了 `"type": "module"` 的项目中执行脚本报错的问题。
- **[自动清理]** 插件初始化时会自动删除旧的 `windsurf_chat.js` 文件，确保只保留最新的 `.cjs` 版本。
- **[规则更新]** 插件初始化时会自动更新 `.windsurfrules` 文件中的插件规则部分，确保规则始终是最新版本（如脚本路径从 `.js` 更新为 `.cjs`）。
- 更新所有相关文档（`ARCHITECTURE.md`）中的脚本引用。

## [1.6.0] - 2026-01-14

### 新增与改进
- **[重大改进] 多根工作区（Multi-root Workspace）支持**：端口文件现在会自动同步到所有已打开的工作区根目录，彻底解决在子项目运行脚本连接失败的问题。
- **全链路 RequestID 追踪**：弃用单实例状态，改为通过 Webview 端到端透传 ID，彻底消除高并发或延迟交互下的竞态条件 Bug。
- **资源管理增强**：更严格的 `http.Server` 销毁流程和端口清理机制，确保插件卸载或重启后无任何残留残留。
- **UI 对话状态优化**：增强了 Webview 与后台通信的握手可靠性。

## [1.5.2] - 2026-01-14

### 修复
- **[关键修复]** 解决请求响应的竞争问题，引入 `activeRequestId` 确保面板响应与请求 ID 严丝合缝。
- **内存优化**：在插件销毁时确保所有挂起的计时器被正确清理，避免潜在的内存泄漏。

## [1.5.1] - 2026-01-14

### 修复
- **[关键修复]** 解决“刚发起请求就立即超时”的幽灵计时器问题。
- **并发安全**：重构 `HttpService` 支持多请求映射，确保每个请求拥有独立的计时器。
- **计时器管理**：引入 `clearTimeout` 机制，在请求完成或重置时立即清理旧闹钟。

## [1.5.0] - 2026-01-14

### 改进 (Clean Code & KISS)
- **代码重构**：将臃肿的 `extension.ts` 拆解为 `HttpService`, `WorkspaceManager` 和 `ExtensionStateManager`。
- **配置统一**：引入 `constants.ts` 集中管理所有魔法数字和字符串常量。
- **模块化**：使用标准的 TypeScript 导入替代 `require`，提升类型安全。
- **健壮性**：优化端口寻找算法和错误处理机制。

## [1.1.4] - 2026-01-14

### 修复
- **[关键修复]** 修复端口连接失败问题（ECONNREFUSED 127.0.0.1:34500）
- 脚本改用 `__dirname` 定位端口文件，不再依赖不可靠的 `process.cwd()`
- 确保在任何执行目录下都能正确读取端口配置

### 改进
- 增强端口文件读取的容错性，添加详细错误日志
- 简化代码逻辑，移除不必要的递归查找

## [1.1.2] - 2026-01-13

### 新增
- 脚本返回时自动追加提醒文本，防止 AI 忘记调用脚本
- 每次脚本输出都会显示 "⚠️ 重要提醒：遵循工作区规则，每次回复结束前必须调用脚本！"

### 改进
- 提升 AI 调用脚本的可靠性，大幅降低遗忘概率

## [1.1.1] - 2026-01-13

### 修复
- 修复白色主题下等待指示器文字不可见的问题
- 修复白色主题下输入框边框不可见的问题
- 修复 `.windsurfrules` 文件逻辑：如果项目已有该文件但不包含插件规则，则智能追加规则

### 改进
- 等待指示器使用更通用的 VSCode 颜色变量（`infoBackground/infoForeground`）
- 输入框边框添加回退颜色 `rgba(128, 128, 128, 0.35)`，确保在所有主题下可见
- `.windsurfrules` 文件使用标记 `<!-- WINDSURF_CHAT_OPEN_V1 -->` 进行智能检测和追加

## [1.1.0] - 2026-01-XX

### 初始版本
- 实现 WindsurfChat 开源版核心功能
- 支持 AI 暂停等待用户输入
- 支持文本和图片反馈
- 自动工作区初始化
- HTTP 服务器通信机制
- 自动清理临时文件
