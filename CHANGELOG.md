# 更新日志

所有重要的项目变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [2.0.4] - 2026-02-13

### 新增
- **[Reply 开关]** 面板 header 新增 Reply 开关，开启后 AI 回复内容会显示在面板卡片上，使用 GPT 等吞回复的模型时建议开启
- **[--reply 参数]** CLI 脚本支持 `--reply` 参数，AI 回复内容作为独立字段传入，面板上单独显示（💬 蓝色左边框）
- **[动态规则生成]** Reply 开关变化时自动重新生成 `.windsurfrules`，开启时包含 `--reply` 参数说明，关闭时不包含

### 改进
- **[规则精简]** `.windsurfrules` 模板精简为中文，移除冗余约束（RULE #1 大标题块、Hard requirement、EXECUTION FLOW 重复说明等）
- **[Reply 独立显示]** reply 内容不再拼接到 prompt，面板上独立展示，不截断

## [2.0.2] - 2026-02-13

### 修复
- **[超时重复对话]** 修复超时后面板旧对话卡片未关闭，导致 AI 再次调用脚本时出现两个对话卡片的问题
- **[结束指令失效]** 加强 end 指令输出，确保 AI 收到结束信号后停止调用脚本
- **[.gitignore 重复写入]** 修复 `# WindsurfChatOpen` 注释头和条目可能被重复追加的问题，改为逐行精确匹配
- **[activeRequestId 残留引用]** 移除超时处对已删除属性的引用，消除编译隐患

## [2.0.0] - 2026-02-06

### 新增
- **[多对话支持]** 支持同时处理多个 AI 对话请求，每个对话独立卡片，垂直堆叠排列
- **[用户问题显示]** 面板卡片同时展示用户的原始问题和 AI 状态，上下文一目了然
- **[对话自动恢复]** 面板意外重建时自动恢复所有等待中的对话，不再丢失

### 改进
- **[提示词优化]** 重写 `.windsurfrules`，解决部分 AI 模型不在面板输出内容的问题
- **[Webview 拆分]** 面板模板拆分为独立的 HTML/CSS/JS 文件，提升可维护性
- **[端口同步]** 面板端口显示始终与实际服务端口保持一致

## [1.7.0] - 2025-01-23

### 新增
- **[文件拖拽功能]** 支持拖拽文本文件到输入框，显示为文件标签 `📄 文件名 ×`
- **[文件夹拖拽]** 支持拖拽文件夹到输入框，显示为文件夹标签 `📁 文件夹名 ×`
- **[文字中间插入]** 支持在文字任意位置拖放文件，使用鼠标坐标精确定位插入位置
- **[相对路径转换]** 发送时自动将文件路径转换为相对于工作区的路径，简洁且跨平台兼容
- **[ContentEditable 输入]** 将 textarea 升级为 contenteditable div，支持富文本编辑

### 改进
- **[代码模块化]** 将 panelTemplate.ts (872行) 拆分为 3 个模块：
  - panelTemplate.ts (88行) - HTML 结构
  - panelStyles.ts (378行) - CSS 样式
  - panelScript.ts (464行) - JavaScript 逻辑
- **[Clean Code 优化]** 提取工具函数，符合 KISS 原则：
  - `parseFileUri()` - 处理 file:// URI 解析
  - `getFileName()` - 从路径中提取文件名
  - `toRelativePath()` - 转换为相对路径
- **[路径处理简化]** 拖拽时保存原始路径，发送时统一转换，逻辑更清晰
- **[视觉反馈]** 拖拽悬停时输入框高亮显示

### 修复
- **[JavaScript 转义错误]** 修复 replace 函数中反斜杠转义层数错误
- **[Windows 路径解析]** 修复 file:/// URI 解析导致的路径格式错误
- **[TypeScript 类型]** 添加 WebviewMessage 类型中缺失的 'getWorkspaceRoot'

### 技术细节
- 使用 `caretRangeFromPoint()` 根据鼠标坐标确定插入位置
- 文件标签设置 `contentEditable="false"` 实现整体删除
- 使用 `split().join()` 替代复杂的正则表达式转义

## [1.6.4] - 2026-01-22

### 新增
- **[连接状态监控]** 添加连接状态实时监控，前端每10秒检查一次服务可用性
- **[连接状态指示]** 面板顶部显示连接状态指示灯（绿色=正常，红色=断开）
- **[健康检查接口]** 新增 `/health` 和 `/status` 接口用于连接检测和调试
- **[超时时间配置]** 面板上可直接配置请求超时时间（0=不限制）

### 改进
- **[长连接优化]** HTTP 服务器配置优化，设置 `timeout=0`、`keepAliveTimeout=0` 保持长连接
- **[自动清理机制]** 后端每30秒自动检查并清理已断开的连接
- **[请求追踪]** 记录每个请求的创建时间，便于追踪和调试
- **[错误处理]** 完善文件系统操作的错误处理和竞态条件保护
- **[资源限制]** 添加 HTTP 请求体大小限制（10MB）、图片数量限制（10张）、图片大小限制（5MB）
- **[代码质量]** 消除所有魔法数字，错误消息集中管理，提升类型安全性

### 修复
- **[端口冲突]** 修复端口冲突处理逻辑，改为顺序递增避免重复尝试
- **[连接断开]** 修复用户反馈的"提交内容没反应"问题，增强连接稳定性
- **[定期清理]** 添加临时文件定期清理机制（每小时）

## [1.6.3] - 2026-01-16

### 改进
- 版本维护更新

## [1.6.1] - 2026-01-15

### 修复
- **[兼容性修复]** 将脚本文件从 `.js` 改为 `.cjs` 扩展名，解决在设置了 `"type": "module"` 的项目中执行脚本报错的问题。
- **[自动清理]** 插件初始化时会自动删除旧的 `windsurf_chat.js` 文件，确保只保留最新的 `.cjs` 版本。
- **[规则更新]** 插件初始化时会自动更新 `.windsurfrules` 文件中的插件规则部分，确保规则始终是最新版本（如脚本路径从 `.js` 更新为 `.cjs`）。
- 更新所有相关文档（`ARCHITECTURE.md`）中的脚本引用。

## [1.6.0] - 2026-01-14

### 新增与改进
- **[重大改进] 多根工作区（Multi-root Workspace）支持**：端口文件现在会自动同步到所有已打开的工作区根目录，彻底解决在子项目运行脚本连接失败的问题。
- **全链路 RequestID 追踪**：弃用单实例状态，改为通过 Webview 端到端透传 ID，彻底消除高并发或延迟交互下的竞态条件 Bug。
- **资源管理增强**：更严格的 `http.Server` 销毁流程和端口清理机制，确保插件卸载或重启后无任何残留残留。
- **UI 对话状态优化**：增强了 Webview 与后台通信的握手可靠性。

## [1.5.2] - 2026-01-14

### 修复
- **[关键修复]** 解决请求响应的竞争问题，引入 `activeRequestId` 确保面板响应与请求 ID 严丝合缝。
- **内存优化**：在插件销毁时确保所有挂起的计时器被正确清理，避免潜在的内存泄漏。

## [1.5.1] - 2026-01-14

### 修复
- **[关键修复]** 解决“刚发起请求就立即超时”的幽灵计时器问题。
- **并发安全**：重构 `HttpService` 支持多请求映射，确保每个请求拥有独立的计时器。
- **计时器管理**：引入 `clearTimeout` 机制，在请求完成或重置时立即清理旧闹钟。

## [1.5.0] - 2026-01-14

### 改进 (Clean Code & KISS)
- **代码重构**：将臃肿的 `extension.ts` 拆解为 `HttpService`, `WorkspaceManager` 和 `ExtensionStateManager`。
- **配置统一**：引入 `constants.ts` 集中管理所有魔法数字和字符串常量。
- **模块化**：使用标准的 TypeScript 导入替代 `require`，提升类型安全。
- **健壮性**：优化端口寻找算法和错误处理机制。

## [1.1.4] - 2026-01-14

### 修复
- **[关键修复]** 修复端口连接失败问题（ECONNREFUSED 127.0.0.1:34500）
- 脚本改用 `__dirname` 定位端口文件，不再依赖不可靠的 `process.cwd()`
- 确保在任何执行目录下都能正确读取端口配置

### 改进
- 增强端口文件读取的容错性，添加详细错误日志
- 简化代码逻辑，移除不必要的递归查找

## [1.1.2] - 2026-01-13

### 新增
- 脚本返回时自动追加提醒文本，防止 AI 忘记调用脚本
- 每次脚本输出都会显示 "⚠️ 重要提醒：遵循工作区规则，每次回复结束前必须调用脚本！"

### 改进
- 提升 AI 调用脚本的可靠性，大幅降低遗忘概率

## [1.1.1] - 2026-01-13

### 修复
- 修复白色主题下等待指示器文字不可见的问题
- 修复白色主题下输入框边框不可见的问题
- 修复 `.windsurfrules` 文件逻辑：如果项目已有该文件但不包含插件规则，则智能追加规则

### 改进
- 等待指示器使用更通用的 VSCode 颜色变量（`infoBackground/infoForeground`）
- 输入框边框添加回退颜色 `rgba(128, 128, 128, 0.35)`，确保在所有主题下可见
- `.windsurfrules` 文件使用标记 `<!-- WINDSURF_CHAT_OPEN_V1 -->` 进行智能检测和追加

## [1.1.0] - 2026-01-XX

### 初始版本
- 实现 WindsurfChat 开源版核心功能
- 支持 AI 暂停等待用户输入
- 支持文本和图片反馈
- 自动工作区初始化
- HTTP 服务器通信机制
- 自动清理临时文件
